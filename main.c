#include <stdint.h>
#include <sys/mman.h>
#include <string.h>
#include <stdio.h>

void xor_decrypt(uint8_t *buf, size_t len, uint16_t key);

int main()
{

	char input[64];
	printf("WELCOME TRAVELLER, SPEAK THY SHAN'T BE STONED: ");
	fflush(stdout);
	if (scanf("%63s", input) != 1)
	{
		return 1;
	}

	uint8_t code[] = {0x62, 0x9a, 0xd2, 0x90, 0xdb, 0x33, 0xf0, 0x56, 0xdf, 0x63, 0x40, 0x7d, 0x5e, 0xd4, 0x72, 0xff, 0x59, 0x74, 0x1a, 0x60, 0xf0, 0x56, 0xc7, 0x7a, 0x59, 0x70, 0x52, 0xd4, 0x72, 0xe7, 0x1a, 0x22, 0x04, 0x20, 0x51, 0xd4, 0x72, 0xeb, 0x00, 0x13, 0xf0, 0x56, 0xcb, 0x13, 0x37, 0x13, 0x37, 0x98, 0x62, 0xef, 0xbc, 0x56, 0x3f, 0x12, 0xe7, 0x1c, 0x81, 0x13, 0xbf, 0x56, 0xcc, 0x9e, 0x62, 0xfb, 0xbc, 0x56, 0xcb, 0x12, 0xe7, 0x1c, 0x81, 0x13, 0xbf, 0x56, 0xcd, 0x1c, 0x81, 0x56, 0xcc, 0x29, 0x72, 0xe9, 0x43, 0x14, 0x8f, 0x13, 0x37, 0x13, 0x37, 0xf8, 0x24, 0x93, 0x4a, 0xe8, 0x37, 0x66, 0x30, 0xab, 0x36, 0x13, 0x37, 0x13, 0xdc, 0x15, 0xb4, 0x56, 0xcb, 0x12, 0xdc, 0xd2, 0xfe, 0xd0}; // encrypted xor

	void *mem = mmap(NULL, 1024, PROT_READ | PROT_WRITE | PROT_EXEC, MAP_ANON | MAP_PRIVATE, -1, 0); // create a protected executable anonymous private memory region

	memcpy(mem, code, sizeof(code)); // copy the code to that region

	xor_decrypt((uint8_t *)mem, sizeof(code), 0x1337); // decrypt mem in runtime (use sizeof code as we only need to decrypt that many bytes)

	int (*validate_func)(const char *) = mem; // cast a function pointer and point it to mem
	int ok = validate_func(input);
	puts(ok ? "YOU ARE SAVED TRAVELLER, YOU MAY PROCEED!" : "YOU GOT STONED BY THE MEDUSA!");
}

void xor_decrypt(uint8_t *buf, size_t len, uint16_t key)
{
	uint8_t key_bytes[2];
	key_bytes[0] = key & 0xFF;		  // lower byte
	key_bytes[1] = (key >> 8) & 0xFF; // upper byte

	for (size_t i = 0; i < len; i++)
	{
		buf[i] ^= key_bytes[i % 2]; // alternate between lower and upper byte
	}
}